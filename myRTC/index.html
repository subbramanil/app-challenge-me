<!DOCTYPE html>
<html>
<head>
	<title>Text Messaging</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
</head>
<body>

	<div class="panel panel-primary col-md-6">
		<div class="panel-heading">
			Myself
		</div>
		<div class="panel-body">
			<textarea id="dataChannelSend" disabled placeholder="Press Start, enter some text, then press Send."></textarea>
		</div>
		<div class="panel-footer">
			<button class="btn btn-success" type="button" id="startBtn1">
        		<span class="glyphicon glyphicon-play" aria-hidden="true"></span>
        	</button>
        	<button class="btn btn-success" type="button" id="sendBtn1">
        		<span class="glyphicon glyphicon-send" aria-hidden="true"></span>
        	</button>
        	<button class="btn btn-danger" type="button" id="closeBtn1">
        		<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
        	</button>
		</div>
	</div>
	<div class="panel panel-primary col-md-6">
		<div class="panel-heading">
			Other Person
		</div>
		<div class="panel-body">
			<textarea id="dataChannelReceive" disabled placeholder="Press Start, enter some text, then press Send."></textarea>
		</div>
		<div class="panel-footer">
			<!-- <button class="btn btn-success" type="button" id="startBtn2">
        		<span class="glyphicon glyphicon-play" aria-hidden="true"></span>
        	</button>
        	<button class="btn btn-success" type="button" id="sendBtn2">
        		<span class="glyphicon glyphicon-send" aria-hidden="true"></span>
        	</button>
        	<button class="btn btn-danger" type="button" id="closeBtn2">
        		<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
        	</button> -->
		</div>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src='lib/adapter.js'></script>
	<script type="text/javascript">
		var sendChannel, receiveChannel;

		var startButton = document.getElementById("startBtn1");
		var sendButton = document.getElementById("sendBtn1");
		var closeButton = document.getElementById("closeBtn1");
		startButton.disabled = false;
		sendButton.disabled = true;
		closeButton.disabled = true;
		startButton.onclick = createConnection;
		sendButton.onclick = sendData;
		closeButton.onclick = closeDataChannels;

		function trace(text) {
		  console.log((performance.now() / 1000).toFixed(3) + ": " + text);
		}

		function createConnection() {
	    	var servers = null;
	  		window.localPeerConnection = new RTCPeerConnection(servers,
	    			{optional: [{RtpDataChannels: true}]});
	  		trace('Created local peer connection object localPeerConnection');

		  	try {
		    	// Reliable Data Channels not yet supported in Chrome
		    	sendChannel = localPeerConnection.createDataChannel("sendDataChannel",
		      		{reliable: false});
		    	trace('Created send data channel');
		    	console.log(sendChannel);
		  	} catch (e) {
		    	alert('Failed to create data channel. ' +
		          'You need Chrome M25 or later with RtpDataChannel enabled');
		    	trace('createDataChannel() failed with exception: ' + e.message);
		  	}
	  		localPeerConnection.onicecandidate = gotLocalCandidate;
	  		trace('Created gotLocalCandidate');
	  		console.log(localPeerConnection);
	  		sendChannel.onopen = handleSendChannelStateChange;
	  		sendChannel.onclose = handleSendChannelStateChange;

	  		window.remotePeerConnection = new RTCPeerConnection(servers,
	    		{optional: [{RtpDataChannels: true}]});
	  		trace('Created remote peer connection object remotePeerConnection');

	  		remotePeerConnection.onicecandidate = gotRemoteIceCandidate;
	  		remotePeerConnection.ondatachannel = gotReceiveChannel;
	  		trace('Created gotRemoteIceCandidate');
	  		console.log(localPeerConnection);

	  		localPeerConnection.createOffer(gotLocalDescription,handleError);
	  		startButton.disabled = true;
	  		closeButton.disabled = false;
	  		trace('connection established');
		}

		function sendData() {
			var data = document.getElementById("dataChannelSend").value;
			sendChannel.send(data);
			trace('Sent data: ' + data);
		}

		function closeDataChannels() {
			trace('Closing data channels');
			sendChannel.close();
			trace('Closed data channel with label: ' + sendChannel.label);
			receiveChannel.close();
			trace('Closed data channel with label: ' + receiveChannel.label);
	  		localPeerConnection.close();
	  		remotePeerConnection.close();
	  		localPeerConnection = null;
	  		remotePeerConnection = null;
	  		trace('Closed peer connections');
	  		startButton.disabled = false;
	  		sendButton.disabled = true;
	  		closeButton.disabled = true;
	  		dataChannelSend.value = "";
	  		dataChannelReceive.value = "";
	  		dataChannelSend.disabled = true;
	  		dataChannelSend.placeholder = "Press Start, enter some text, then press Send.";
		}

		function gotLocalDescription(desc) {
	  		localPeerConnection.setLocalDescription(desc);
	  		trace('Offer from localPeerConnection \n' + desc.sdp);
	  		remotePeerConnection.setRemoteDescription(desc);
	  		remotePeerConnection.createAnswer(gotRemoteDescription,handleError);
		}

		function gotRemoteDescription(desc) {
	  		remotePeerConnection.setLocalDescription(desc);
	  		trace('Answer from remotePeerConnection \n' + desc.sdp);
	  		localPeerConnection.setRemoteDescription(desc);
		}

		function gotLocalCandidate(event) {
	  		trace('local ice callback');
	  		if (event.candidate) {
	    		remotePeerConnection.addIceCandidate(event.candidate);
	    		trace('Local ICE candidate: \n' + event.candidate.candidate);
	  		}
		}

		function gotRemoteIceCandidate(event) {
			trace('remote ice callback');
	  		if (event.candidate) {
	    		localPeerConnection.addIceCandidate(event.candidate);
	    		trace('Remote ICE candidate: \n ' + event.candidate.candidate);
	  		}
		}

		function gotReceiveChannel(event) {
	  		trace('Receive Channel Callback');
	  		receiveChannel = event.channel;
	  		receiveChannel.onmessage = handleMessage;
	  		receiveChannel.onopen = handleReceiveChannelStateChange;
	  		receiveChannel.onclose = handleReceiveChannelStateChange;
		}

		function handleMessage(event) {
	  		trace('Received message: ' + event.data);
	  		document.getElementById("dataChannelReceive").value = event.data;
		}

		function handleSendChannelStateChange() {
	  		var readyState = sendChannel.readyState;
	  		trace('Send channel state is: ' + readyState);
	  		if (readyState == "open") {
	    		dataChannelSend.disabled = false;
	    		dataChannelSend.focus();
	    		dataChannelSend.placeholder = "";
	    		sendButton.disabled = false;
	    		closeButton.disabled = false;
	  		} else {
	    		dataChannelSend.disabled = true;
	    		sendButton.disabled = true;
	    		closeButton.disabled = true;
	  		}
		}

		function handleReceiveChannelStateChange() {
	  		var readyState = receiveChannel.readyState;
	  		trace('Receive channel state is: ' + readyState);
		}

		function handleError(){}

	</script>
</body>
</html>