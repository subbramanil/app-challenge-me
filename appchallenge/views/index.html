<!DOCTYPE html>
<html>
<head>
<title>Home</title>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<link rel="stylesheet"
	href="https://cdn.datatables.net/1.10.5/css/jquery.dataTables.min.css" />
<style type="text/css">
	video {
	  width: 307px;
	  height: 250px;
	  background: rgba(255,255,255,0.5);
	  border: 1px solid #ccc;
	  -webkit-filter: grayscale(1);
	}
	td.details-control {
    	background: url('../resources/details_open.png') no-repeat center center;
    	cursor: pointer;
	}
</style>

<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript"
	src="https://cdn.datatables.net/1.10.5/js/jquery.dataTables.min.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script>
	var socket = io.connect('http://localhost:8080');
	var user = null;

	function trace(text) {
		console.log((performance.now() / 1000).toFixed(3) + ": " + text);
	}

	// on connection to server, ask for user's name with an anonymous callback
	socket.on('connect', function(){
		// call the server-side function 'adduser' and send one parameter (value of prompt)
		var userName = prompt("What's your name?");
		if(userName){
			var userData = {"name":userName, "emailID":userName+"@gmail.com", "status":"online"};
			socket.emit('addUser', userData);
			// Get all the available rooms
			socket.emit('getAllRooms');
		}
	});

	// listener, whenever the server emits 'updateusers', this updates the username list
	socket.on('updateUsers', function(data) {
		console.log("Updating Users");
		$('#userInfo').empty();
		user = JSON.parse(data);
		console.log(user);
		$('#userInfo').append('<li>'+ user.userName+'</li>')
		$('#userInfo').append('<li>'+ user.userMailID+'</li>')
		$('#userInfo').append('<li>'+ user.available+'</li>')
	});

	socket.on('updateRooms', function(status, data){
		if(status){
			console.log(data);
			var rooms = JSON.parse(data);

			if ( $.fn.dataTable.isDataTable( '#roomDetails' ) ) {
					console.log("Deleting existing table");
					$("#roomDetails").dataTable().fnDestroy();
				}
				
				$('#roomDetails').dataTable( {
					"data": rooms,
					"aoColumns": [
					{
						"mData":"roomName",
						"sTitle": "Room Name",
				  	},
				  	{
				  		"mData":"desc",
					    "sTitle": "Description",
					    "orderable": false
				  	},
				  	{
				  		"mData":"host.userName",
					    "sTitle": "Host",
				  	},
				  	{
				  		"mData":"count",
					    "sTitle": "# of participants",
				  	},
            		{   
            			"sTitle": "Action",
            			"mData": null,
                    	"orderable": false,
            			"mRender": function (obj) {
            				return '<a class="btn btn-success" onclick="joinRoom('+obj.roomID+')">' + 'Join' + '</a>';
            			}
            		}
				  ]
		   		});
		}else{
			$('#statusMsgsList').empty();
			$('#statusMsgsList').append('<li> No rooms available <li>');
		}
	});

	socket.on('statusUpdate', function(msg){
		console.log("status updated");
		$('#statusMsgsList').empty();
		$('#statusMsgsList').append('<li>' + msg + '<li>');
	});

	socket.on('updateUserCount', function(roomData){
		var data = JSON.parse(roomData);
		console.log(data);
		var table = $('#roomDetails').DataTable();
		table.rows().indexes().each( function (idx) {
			var d = table.row( idx ).data();
			console.log(d.roomID+" "+data.roomID);
		    if(d.roomID == data.roomID){
		    	console.log("found");
		    	d.count = data.count;
		    	console.log(table.row( idx ).data(d));
		    }
		} );
		 
		// Draw once all updates are done
		table.draw();
	});

	function joinRoom(roomID){
		var data = {"roomID":roomID, "user":user};
		trace("Joining Room");
		console.log(data);
		socket.emit('joinRoom', data);
	}

	$(document).ready(function(){
		$('#addRoom').click(function(){
			var roomName = prompt("Enter the room name:");
			var roomData = {"name":roomName, "desc":"To Paint as a Group"};
			socket.emit('addRoom', roomData);
		});
	});

	/* JS code for video call*/
	// var localMediaStream = null;

	var constraints = {
		video: true
    };

    function hasGetUserMedia() {
		return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
	        	navigator.mozGetUserMedia || navigator.msGetUserMedia);
	}

	if (hasGetUserMedia()) {
		console.log("Your Browser is : "+navigator.userAgent);
		console.log("getUserMedia() is supported in your browser");
		console.log("More info about the browser: ");
		console.log(navigator);
		navigator.getUserMedia = navigator.getUserMedia ||
							navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
	} else {
		alert('getUserMedia() is not supported in your browser');
	}

	function successCallback(localMediaStream) {
		console.log("Success Callback method"+ navigator.getUserMedia);
		window.stream = localMediaStream; // stream available to console
		console.log(stream);
		console.log(stream.getVideoTracks());
		// stream.stop();
		// console.log("stream stopped");
		var video = document.querySelector("video");
		console.log(video);
		video.src = window.URL.createObjectURL(localMediaStream);
		video.play();			
	}

	function errorCallback(error){
		console.log("Error Callback method");
		console.log("navigator.getUserMedia error: ", error);

		//video.src = 'fallbackvideo.webm';
	}

	navigator.getUserMedia(constraints, successCallback, errorCallback);

</script>
<body>
	<div class="container-fluid">
		<div class="row"></div>
			<div class="panel panel-primary col-md-6">
				<div class="panel-heading">
					User
				</div>
				<div class="panel-body">
					<ul id="userInfo">

					</ul>
					<video autoplay></video>
				</div>	
			</div>
			<div class="panel panel-primary col-md-6">
				<div class="panel-heading">
					Rooms
				</div>
				<div class="panel-body">
					<table id="roomDetails" class="display">

			    	</table>
					<div>
						<button class="btn btn-success" type="button" id="addRoom">
			        		<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
			        	</button>
					</div>
				</div>	
			</div>
		</div>
		<div class="row">
			<div class="panel panel-primary">
				<div class="panel-heading">
					Messages
				</div>
				<div class="panel-body">
					<ul id="statusMsgsList">
						
					</ul>
				</div>
			</div>	
		</div>
	</div>
</body>
</html>
